/* (c) Copyright 2003-2021, Real-Time Innovations, Inc. All rights reserved. */
/*
 * @(#)transport_tls_openssl.h    generated by: makeheader    Fri Apr 23 02:31:07 2021
 *
 *		built from:	openssl.ifc
 */

#ifndef transport_tls_openssl_h
#define transport_tls_openssl_h


  #ifndef transport_tls_dll_h
    #include "transport_tls/transport_tls_dll.h"
  #endif

  #ifndef dds_c_infrastructure_h
    #include "dds_c/dds_c_infrastructure.h"
  #endif

  /* if required, include openssl/ssl.h before this file */
  #ifndef SSL_ERROR_NONE
    #define X509_STORE_CTX   void
  #endif

#ifdef __cplusplus
    extern "C" {
#endif


typedef int (* NDDS_Transport_TLS_Verify_Callback)
    (int preverify_ok, X509_STORE_CTX *x509_ctx);


struct NDDS_Transport_TLS_Verification {
    /*e
     * \brief Name of file containing Certificate Authority certificates
     *
     *  File should be in PEM format. See the OpenSSL manual page for
     *  SSL_load_verify_locations for more information.
     *
     *  At least one of ca_file and ca_path must be specified; both may be
     *  specified.
     *
     * \default NULL
     */
    char *ca_file;
    /*e
     * \brief Paths to directories containing Certificate Authority certificates
     *
     *  Files should be in PEM format, and follow the OpenSSL-required naming
     *  conventions. See the OpenSSL manual page for SSL_CTX_load_verify_locations
     *  for more information.
     *
     *  At least one of ca_file and ca_path must be specified; both may be
     *  specified.
     *
     * \default NULL
     */
    char *ca_path;
    /*e
     * \brief List of Certificate Authority certificates
     *
     *  Certificates should be in PEM format, and follow the OpenSSL-required naming
     *  conventions. See the OpenSSL manual page for X509_STORE_add_cert
     *  for more information.
     *
     *  ca_file and ca_path have precedence if specified. If not, ca must be
     *  specified.
     *
     * \default NULL
     */
    char * ca;
    /*e
     * \brief Maximum certificate chain length for verification
     *
     *  \default -1 (no limit)
     */
    DDS_Long verify_depth;
    /*e
     * \brief If non-zero, use mutual authentication when performing TLS
     *  handshake; if zero, only client will verify server certificate
     *
     *  \default 0 (non-mutual verify)
     */
    DDS_Long verify_peer;
    /*e
     * \brief Callback used to verify peer certificates
     *
     *  See the OpenSSL manual page for SSL_set_verify for more information.
     *  There are a number of default callbacks included in the Secure
     *  Transport.  See NDDS_Transport_TLS_default_verify_callback() ,
     *  NDDS_Transport_TLS_verbose_verify_callback() .
     *
     * \default NULL (use NDDS_Transport_TLS_default_verify_callback() )
     */
    NDDS_Transport_TLS_Verify_Callback callback;
};


struct NDDS_Transport_TLS_Identity {
    /*e \brief File containing identifying certificate chain (in PEM format)
     *
     * An identifying certificate is required for secure communication.
     * The file must be sorted starting with the certificate to the highest
     * level (root CA).  If no private key is specified, this file will be used
     * to load a non-RSA private key.
     *
     * \default NULL
     */
    char *certificate_chain_file;

    /*e \brief String containing identifying certificate (in PEM format) or
     * certificate chain (appending intermediate CA certs in order).
     *
     * An identifying certificate is required for secure communication.
     * The string must be sorted starting with the certificate to the highest
     * level (root CA).  If this is specified certificate_chain_file must be
     * empty.
     *
     * \default NULL
     */
    char *certificate_chain;

    /*e @brief Password for private key
     *
     * \default NULL (no password)
     */
    char *private_key_password;

    /*e \brief File containing private key (in PEM format)
     *
     * If no private key is specified (all values are NULL), this value will
     * default to the same file as the specified certificate chain file.
     * 
     * \default NULL
     */
    char *private_key_file;

    /*e \brief String containing private key (in PEM format)
     *
     * At most one of private_key and private_key_file may be specified.  If no
     * private key is specified (all values are NULL), the private key will be read
     * from the certificate chain file.
     * 
     * \default NULL
     */
    char *private_key;

    /*e \brief File containing RSA private key (in PEM format)
     *
     * \default NULL
     */
    char *rsa_private_key_file;
};


struct NDDS_Transport_TLS_DHParamFile {
    /*e \brief Name of DH key file
     *
     * \default 0
     */
    char *file;

    /*e \brief Length of DH key in bits
     *
     * \default NULL
     */
    DDS_Long bits;
};


struct NDDS_Transport_TLS_Ciphers {
    /*e \brief List of available DTLS ciphers for TLS 1.2 or below
     *
     * See the OpenSSL manual page for SSL_set_cipher_list for more information
     * on the format of this string
     *
     * \default NULL
     */

    char *cipher_list; /* cipher list in OpenSSL format */

    /*i \brief List of available DTLS ciphersuites for TLS 1.3
     *
     * See the OpenSSL manual page for SSL_CTX_set_ciphersuites for more
     * information on the format of this string
     *
     * \default NULL
     */

    char *ciphersuites; /* ciphersuites in OpenSSL format */

    /*e \brief Number of DH key files supplied
     *
     * \default 0
     */
    DDS_Long dh_param_files_length;

    /*e \brief List of available DH key files
     * 
     * \default NULL
     */
    struct NDDS_Transport_TLS_DHParamFile *dh_param_files;

    /*e \brief ID of OpenSSL cipher engine to request
     *
     * \default NULL
     */
    char *engine_id;

    /*i \brief pre-load commands: length, name/parameter pairs */
    DDS_Long engine_pre_cmd_length;
    const char **engine_pre_cmd_names, **engine_pre_cmd_parameters;
    /*i \brief post-load commands: length, name/parameter pairs */
    DDS_Long engine_post_cmd_length;
    const char **engine_post_cmd_names, **engine_post_cmd_parameters;
};


struct NDDS_Transport_TLS_Renegotiate {
    /*i \brief Force renegotiation after connection open for time period
     *
     * \default DDS_DURATION_INFINITE
     */
    struct DDS_Duration_t force_after_time;

    /*i \brief Force renegotiation after amount of data transferred
     *
     * Data sent or received, measured in total unencryted length (0 = no force)
     *
     * \default 0
     */
    DDS_UnsignedLong force_after_Kbytes;

    /*i \brief Require renegotiation to complete with this period
     *
     * \default DDS_DURATION_INFINITE
     */
    struct DDS_Duration_t completion_period;
};


typedef enum {
    NDDS_TRANSPORT_TLS_PROTOCOL_TLS = 0,
    NDDS_TRANSPORT_TLS_PROTOCOL_DTLS = 1
} NDDS_Transport_TLS_Protocol_t;


struct NDDS_Transport_TLS_OpenSSL_Configuration {
    /*e \brief Verification properties */
    struct NDDS_Transport_TLS_Verification   verify;
    /*e \brief Identity properties */
    struct NDDS_Transport_TLS_Identity       identity;
    /*e \brief Cipher properties */
    struct NDDS_Transport_TLS_Ciphers        cipher;
    /*i \brief Renegotiation properties */
    struct NDDS_Transport_TLS_Renegotiate    renegotiate;
};



/*e \ingroup NDDS_Transport_TLS_Plugin
  \brief Use this to initialize a NDDS_Transport_TLS_Verfication structure.

  \showinitializer
*/
#define NDDS_TRANSPORT_TLS_VERIFY_DEFAULT { \
    NULL, NULL, NULL,/* ca_file, ca_path, ca */ \
    -1, /* verify_depth (no depth limit) */ \
    0, /* verify_peer (NOT mutual) */ \
    NULL /* callback (use default verify callback) */ }

/*e \ingroup NDDS_Transport_TLS_Plugin
  \brief Use this to initialize a NDDS_Transport_TLS_Identity structure.

  \showinitializer
*/
#define NDDS_TRANSPORT_TLS_IDENTITY_DEFAULT { \
    NULL, /* certificate_chain_file */ \
    NULL, /* certificate_chain */ \
    NULL, /* private_key_password */ \
    NULL, /* private_key_file */ \
    NULL, /* private_key */ \
    NULL /* rsa_private_key_file */ }

/*e \ingroup NDDS_Transport_TLS_Plugin
  \brief Use this to initialize a NDDS_Transport_TLS_Chiphers structure.

  \showinitializer
*/
#define NDDS_TRANSPORT_TLS_CIPHER_DEFAULT { \
    NULL, /* cipher_list */ \
    NULL, /* ciphersuites */ \
    0, NULL, /* dh_param_files_length, dh_param_files (no DH params) */ \
    NULL, /* engine_id (no engine) */ \
    0, NULL, NULL, /* engine_pre_cmd_length, engine_pre_cmd_names, engine_pre_cmd_parameters */ \
    0, NULL, NULL /* engine_post_cmd_length, engine_post_cmd_names, engeine_post_cmd_parameters */ }

/*i \ingroup NDDS_Transport_TLS_Plugin
  \brief Use this to initialize a NDDS_Transport_TLS_Renegotiate structure.

  \showinitializer
*/
#define NDDS_TRANSPORT_TLS_RENEGOTIATE_DEFAULT { \
    { 0x7fffffffL, 0x7fffffffUL }, /* force_after_time */ \
    0, /* force_after_Kbytes */ \
    { 0x7fffffffL, 0x7fffffffUL } /* completion_period */ }

/*e \ingroup NDDS_Transport_TLS_Plugin
  \brief Use this to initialize a NDDS_Transport_TLS_OpenSSL_Configuration structure.

  \showinitializer
*/
#define NDDS_TRANSPORT_TLS_OPENSSL_CONFIGURATION_DEFAULT { \
    NDDS_TRANSPORT_TLS_VERIFY_DEFAULT, /* verify */ \
    NDDS_TRANSPORT_TLS_IDENTITY_DEFAULT, /* identity */ \
    NDDS_TRANSPORT_TLS_CIPHER_DEFAULT, /* cipher */ \
    NDDS_TRANSPORT_TLS_RENEGOTIATE_DEFAULT /* renegotiate */ }


extern NDDS_Transport_TLS_DllExport
void NDDS_Transport_TLS_thread_exit();


extern	int NDDS_Transport_TLS_default_verify_callback(int ok, X509_STORE_CTX *store);

extern NDDS_Transport_TLS_DllExport
int NDDS_Transport_TLS_verbose_verify_callback(int ok, X509_STORE_CTX *store);


#ifdef RTI_OPENSSL_ARCHITECTURE
  /* methods below only supported on TLS architectures */

extern NDDS_Transport_TLS_DllExport
int NDDS_Transport_TLS_configuration_verify(
    const struct NDDS_Transport_TLS_OpenSSL_Configuration *config);

extern NDDS_Transport_TLS_DllExport
SSL_CTX *NDDS_Transport_TLS_context_init(
    NDDS_Transport_TLS_Protocol_t protocol,
    const struct NDDS_Transport_TLS_OpenSSL_Configuration *config);

extern NDDS_Transport_TLS_DllExport
void NDDS_Transport_TLS_context_done(SSL_CTX *context);


#endif /*RTI_OPENSSL_ARCHITECTURE*/

#ifdef __cplusplus
    }	/* extern "C" */
#endif


#endif /* transport_tls_openssl_h */
